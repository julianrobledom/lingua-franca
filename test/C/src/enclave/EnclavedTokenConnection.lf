// This tests that the enclaved connections also can carry tokens and dynamically
// allocated memory
target C {
  timeout: 1 sec
}

reactor Src {
  output out: int*
  timer t(0, 100 msec)

  reaction(t) -> out {=
    int * x = (int *) malloc(sizeof(int));
    *x = 42;
    lf_set(out, x);
  =}
}

reactor Double {
  input in: int*
  output out: int*

  reaction(in) -> out {=
    int * x = (int *) malloc(sizeof(int));
    *x = (*in->value)*2;
    lf_set(out, x);
  =}
}

reactor Dest {
  input in: int*

  reaction(in) {=
    LF_ASSERT(*in->value == 84, "Received wrong value");
  =}
}

main reactor {
  @enclave
  src = new Src()

  @enclave
  dbl = new Double()

  @enclave
  dest = new Dest()

  src.out, dbl.out -> dbl.in, dest.in after 50 msec
}
